var ChromePlatformAnalytics=function(){var n,e,t=function(){chrome.runtime.onMessage.addListener(function(n,e,t){"object"==typeof n&&("cpa.sendAppView"===n.cmd?a(n.data):"cpa.sendEvent"===n.cmd?c(n.data):"cpa.toggle"===n.cmd&&i(n.data))})},a=function(n){e.sendAppView(n)},c=function(n){e.sendEvent.apply(e,n)},i=function(e){n.getConfig().addCallback(function(n){n.setTrackingPermitted(!!e)})};return{init:function(a,c){t(),n=analytics.getService(a),e=n.getTracker(c)},sendAppView:a,sendEvent:c,toggle:i}}();
var Helpers=function(){var e=function(e,r){void 0===r&&(r=2);var n=Number(e),a=!1;n<0&&(a=!0,n=-n);var o=(e=n.toFixed(r)).split(".");o[0]=Number(o[0]).toLocaleString();var i=t(),c=o.join(i);return a&&(c="-"+c),c},t=function(){var e=".";try{var t=parseFloat(1.5).toLocaleString().substring(1,2);"."!==t&&","!==t||(e=t)}catch(e){}return e};return Object.defineProperty(Array.prototype,"chunk",{value:function(e){for(var t=[],r=0;r<this.length;r+=e)t.push(this.slice(r,r+e));return t}}),Object.defineProperty(Array.prototype,"merge",{value:function(){for(var e=0;e<arguments.length;e++)for(var t=arguments[e],r=0;r<t.length;r++)-1===this.indexOf(t[r])&&this.push(t[r]);return this}}),String.prototype.toUpperCaseFirstChar=function(){return this.substr(0,1).toUpperCase()+this.substr(1)},{cleanHTML:function(e,t){return e=(e=(e=e.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"")).replace(/<style[\s\S]*?\/style>/gi,"")).replace(/onload=".*?"/gi,""),t&&t.image||(e=e.replace(/<img[^>]*>/gi,"")),e=e.replace(/<form [\s\S]+?<\/form>/gi,"")},getURLParam:function(e,t){t||(t=document.location);for(var r=t.search.substring(1).split("&"),n=0;n<r.length;n++){var a=r[n].split("=");if(a[0]==e)return a[1]}},removeURLParam:function(e,t){var r=t.split("?")[0],n=[],a=-1!==t.indexOf("?")?t.split("?")[1]:"";if(""!==a){for(var o=(n=a.split("&")).length-1;o>=0;o-=1)n[o].split("=")[0]===e&&n.splice(o,1);r=r+"?"+n.join("&")}return r},getHost:function(e){var t=document.createElement("a");return t.href=e,t.host},getDomainName:function(e){var t=e.split(".").reverse();return t.length>=3&&t[1].match(/^(com|edu|gov|net|mil|org|nom|co|name|info|biz)$/i)?t[2]+"."+t[1]+"."+t[0]:t[1]+"."+t[0]},getDate:function(e,t){void 0===t&&(t=new Date),e||(e="YYYY-MM-DD hh:mm:ss");var r=t.getFullYear(),n="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ")[t.getMonth()],a=("0"+(t.getMonth()+1)).substr(-2),o=("0"+t.getDate()).substr(-2),i=("0"+t.getHours()).substr(-2),c=("0"+t.getMinutes()).substr(-2),u=("0"+t.getSeconds()).substr(-2),s=e;return s=(s=(s=(s=(s=(s=(s=(s=s.replace("YYYY",r)).replace(/YY/g,r.toString().substr(-2))).replace("MMMM",n)).replace("MM",a)).replace("DD",o)).replace("hh",i)).replace("mm",c)).replace("ss",u)},clipboardWrite:function(e){var t=document.createElement("textarea");document.body.appendChild(t),t.value=e,t.select(),document.execCommand("copy"),t.parentNode.removeChild(t)},saveToFile:function(e,t){var r=document.createElement("a");r.download=t,r.href=e,r.click()},arrayToCSV:function(e,t){var r=[];return e.map(function(e){var n='"'+(e=e.map(function(e){return void 0===e&&(e=""),e=(e=(e=e.toString()).replace(/\r?\n|\r/g," ")).replace(/"/g,'""')})).join('"'+t+'"')+'"';r.push(n)}),r.join("\n")},injectInlineJS:function(e,t){t||(t=[]),t=t.map(function(e){return'"'+e+'"'});var r=document.createElement("script");r.textContent="("+e+")("+t.join(",")+")",(document.head||document.documentElement).appendChild(r),r.parentNode.removeChild(r)},formatNumber:e,getDecimalSeparator:t,deepSearchFormatNumber:function(t,r){for(var n=t,a=0,o=(r=r.split(".")).length;a<o;a++){if(void 0===n[r[a]])return;a===o-1?n[r[a]+"_fmt"]=e(n[r[a]],2):n=n[r[a]]}},getNrString:function(e){if("number"!=typeof e)return e;if(0===e)return e+"";var t=parseInt(Math.floor(Math.log(e)/Math.log(1e3)));return Math.round(e/Math.pow(1e3,t),2)+["","K","M","G","T"][t]},percent:function(e){return e?(100*parseFloat(e)).toFixed(0):""},convertPriceToNumber:function(e){var r,n=e.replace(/[^\d,.]+/g,"");return"."===n.substr(-1)&&(n=n.substr(0,n.length-1)),n?("."===(r=(n=n.replace(/[.,]+$/,"")).substr(-3,1).match(/[.,]/)?n.substr(-3,1):n.substr(-2,1).match(/[.,]/)?n.substr(-2,1):t())&&(n=n.replace(/,/g,"")),","===r&&(n=(n=n.replace(/\./g,"")).replace(",",".")),parseFloat(n)):0}}}();
var Cache=function(){var e={};return{get:function(t){var n=Date.now();return e[t]&&n-e[t].timestamp<=6e5?e[t].response:(delete e[t],!1)},set:function(t,n){var a=Date.now();e[t]&&a-e[t].timestamp<=6e5||(e[t]={timestamp:Date.now(),response:n})}}}();
var TaskManager=function(){var n=!1,t=[],i=1e3,u=function(){},a=null,f=function(t){a=setInterval(function(){n||o()},t)},o=function(){if(t[0]){var n=t.shift().task;if("function"==typeof n){var a=Math.floor(Math.random()*(i/2));setTimeout(n,a)}}else"function"==typeof u&&u()};return{init:function(n){i=n.interval,n.onEnd&&(u=n.onEnd),o(),f(i)},updateInterval:function(n){a&&clearInterval(a),f(n)},push:function(n,i){t.push({tabId:n,task:i})},unshift:function(n,i){t.unshift({tabId:n,task:i})},stop:function(){t=[],a&&clearInterval(a)},pause:function(){n=!0},unpause:function(){n=!1},filter:function(n){t=t.filter(n)}}}();
var Errors=function(){var n,r=[],t=120,e=function(n){var t=Date.now();r=r.filter(r=>t-r.ts<=1e3*n)},i=function(){return r.length};return{init:function(r){t=r.period,n=r.onLimitReached},handle:function(o){r.push({ts:Date.now(),error:o}),e(t),i()>3&&n&&n()}}}();
var App=function(){var e,t,a,r="undefined"!=typeof browser,n={checkLimits:!0,loadAllOffers:!1,allowGA:!0,exportOrder:"asin,name,sellerId,type,ratingScore,ratingVal,conditionEn,price,shipPrice,pricePlusShip,qty,limitYN"},o={},i={},s={},c={},d=null,u=function(){ChromePlatformAnalytics.init("osaddon","UA-56097614-9");var e=parseInt(localStorage.lastRunTS||0),t=new Date(e),a=new Date;t.getFullYear()===a.getFullYear()&&t.getMonth()===a.getMonth()&&t.getDate()===a.getDate()||(ChromePlatformAnalytics.sendEvent(["app","init"]),localStorage.lastRunTS=Date.now())},l=function(e){chrome.storage.local.get(["settings","appStorage"],function(t){for(var a in t.settings&&(o=t.settings),n)void 0===o[a]&&(o[a]=n[a]);t.appStorage&&(s=t.appStorage),e&&e()})},f=function(){var e={settings:o,appStorage:s};chrome.storage.local.set(e,function(){})},m=function(){chrome.browserAction.onClicked.addListener(function(e){p(e)})},p=function(e){e.url.match(/^https?:\/\/\w+\.amazon\./)&&h(e)},h=function(e){w(e.id,"WidgetVar",function(){chrome.tabs.executeScript(e.id,{file:"/lib/jquery-3.4.1.min.js"}),chrome.tabs.executeScript(e.id,{file:"/js/cs-exec.js"}),chrome.tabs.insertCSS(e.id,{file:"/css/cs-widget.css"}),setTimeout(function(){chrome.tabs.executeScript(e.id,{file:"/js/cs-widget.js"})},50)},function(){chrome.tabs.sendMessage(e.id,{cmd:"run"})})},w=function(e,t,a,r){var n="injector_"+t,o=function(i,s,c){i.cmd===n&&(i.data?r():(a(),chrome.tabs.executeScript(e,{code:"var "+t+" = true;"})),chrome.runtime.onMessage.removeListener(o))};chrome.runtime.onMessage.addListener(o),chrome.tabs.executeScript(e,{code:'chrome.runtime.sendMessage({cmd: "'+n+'", data: typeof '+t+' !== "undefined"})'},()=>chrome.runtime.lastError)},g=function(){chrome.runtime.onMessage.addListener(function(e,t,a){var r=e.cmd,n=e.data,c=(t.tab||{}).id;if("settings.get"===r)a(o);else if("settings.set"===r)o[n.key]=n.value,f(),function(e,t,a){"allowGA"===e&&ChromePlatformAnalytics.toggle(t)}(n.key,n.value);else if("run"===r)p(t.tab);else{if("offer.getQty"===r){var d=[n.asin,n.page,n.offer.index,n.offer.sellerId].join("_"),u=Cache.get(d);return u?void a(u):(v(n,a,d,1),!0)}if("fetch_offers"===r){var l=Cache.get(n.url);return l?a(l):fetchOffersPage(n.url).then(function(e){e.error?503==e.code&&Errors.handle(e.code):Cache.set(n.url,e),a(e)}),!0}if("url.fetch"===r)return TaskManager.push(c,function(){y(n.url,n.allowCache).then(function(e){e.error&&503==e.code&&Errors.handle(e.code),a(e)})}),!0;if("sc.set_data"===r)i=n;else if("sc.get_data"===r)a(i),i={};else if("notifications.get"===r){for(var m=n,h={},w=0,g=m.length;w<g;w++){var S=m[w],I=s["notification"+S];h[S]=I||!1}h.notificationLastTS=s.notificationLastTS,a(h)}else if("notifications.later"===r){var x="notification"+n.id;s[x]=Date.now(),s.notificationLastTS=Date.now(),f()}else if("notifications.dismiss"===r){x="notification"+n.id;s[x]=!0,s.notificationLastTS=Date.now(),f()}}})},v=function(e,t,a,r){r>3?t({error:!0,data:"error"}):q(e).then(function(n){n.error?v(e,t,a,r+1):(Cache.set(a,n),t(n))})},y=function(e,t){return new Promise(function(a,r){if(t){var n=Cache.get(e);if(n)return void a(n)}$.ajax({method:"GET",url:e,headers:{"X-OSA-Ext":"oa"}}).then(function(r){var n={error:!1,data:r};t&&Cache.set(e,n),a(n)}).fail(function(e,t,r){a({error:!0,code:e.status,data:e.responseText})})})},S=function(){var e={urls:[],types:["xmlhttprequest"]};["*://www.amazon.ae/*","*://www.amazon.com/*","*://www.amazon.co.uk/*","*://www.amazon.es/*","*://www.amazon.nl/*","*://www.amazon.mx/*","*://www.amazon.it/*","*://www.amazon.in/*","*://www.amazon.de/*","*://www.amazon.fr/*","*://www.amazon.cn/*","*://www.amazon.ca/*","*://www.amazon.pl/*","*://www.amazon.sa/*","*://www.amazon.se/*","*://www.amazon.sg/*","*://www.amazon.com.au/*","*://www.amazon.com.br/*","*://www.amazon.com.mx/*","*://www.amazon.com.tr/*","*://www.amazon.co.jp/*"].map(function(t){e.urls.push(t),e.urls.push(t.replace("www","smile"))});var t="blocking requestHeaders",a="blocking responseHeaders";r||(t+=" extraHeaders",a+=" extraHeaders"),chrome.webRequest.onBeforeSendHeaders.addListener(I,e,t.split(" ")),chrome.webRequest.onHeadersReceived.addListener(x,e,a.split(" "))},I=function(e){var t=e.url,a=e.requestHeaders,r=C(a,"X-OSA-Ext");if(!(r<0)){var n=a[r].value.replace("oa","");a.splice(r,1),c[e.requestId]=n||-1;var o=Helpers.getHost(t),i=_.get({sid:n});i||(i={});var s=C(a,"cookie");if(i.cookie){var d=k(i.cookie);s>=0?a[s].value=d:a.push({name:"Cookie",value:d})}else s>=0&&a.splice(s,1);var u="https://"+o;return T(a,"Cache-Control","no-cache"),T(a,"Origin",u),T(a,"upgrade-insecure-requests","1"),i.ua&&T(a,"User-Agent",i.ua),a.map(function(e){}),{requestHeaders:a}}},x=function(e){var t,a=e.url,r=c[e.requestId];if(r&&(delete c[e.requestId],t=-1===r?{}:_.get({sid:r}))){var n=e.responseHeaders,o=[];return n.map(function(e){if("set-cookie"===e.name.toLowerCase()){var a=O(e.value);if("-"===a.value)return;t.cookie||(t.cookie={}),t.cookie[a.name]=a.value,"session-id"===a.name.toLowerCase()&&(t.amzSessionId=a.value)}else o.push(e)}),a.indexOf("address-change.html"),{responseHeaders:o}}},C=function(e,t){for(var a=0,r=e.length;a<r;a++){if(e[a].name.toLowerCase()===t.toLowerCase())return a}return-1},T=function(e,t,a){var r=C(e,t);r>=0?e[r].value=a:e.push({name:t,value:a})},O=function(e){var t,a;return[e,...a]=e.split(";"),-1===(t=e.indexOf("="))?null:{name:e.substr(0,t),value:e.substr(t+1),options:a}},k=function(e){var t=[];for(var a in e)t.push(`${a}=${e[a]}`);return t.join("; ")},q=async function(e){var t=e.host,a=e.asin,r=e.offer.offerId,n=await A(t,a);if(!n.address){if(!await b(t,a,n))return{error:!0,data:"address change failed"};n.address=!0}return await M({host:t,sid:n.sid,offerId:r,amzSessionId:n.amzSessionId,asin:a})},A=async function(e,t){let a=e+"_"+t,r=_.get({key:a});if(r)return r;r=_.add(a),setTimeout(function(){_.clear({key:a})},3e5);let n=await fetch("https://"+e+"/amazonprime",{headers:{"X-OSA-Ext":"oa"+r.sid}}),o=(await n.text()).match(/nav-global-location-data-modal-action.*anti-csrftoken-a2z&quot;:&quot;(.*?)&quot;/);return o&&(r.csrfGeo=o[1]),r},b=async function(e,t,a){let r=a.sid,n="https://"+e+"/portal-migration/hz/glow/get-rendered-toaster?pageType=Gateway&aisTransitionState=in&rancorLocationSource=IP_GEOLOCATION&_="+Date.now(),o=await fetch(n,{headers:{"X-OSA-Ext":"oa"+r,accept:"text/html,*/*",downlink:"10",origin:"",referer:"https://"+e+"/","sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"same-origin","sec-fetch-user":"","x-requested-with":"XMLHttpRequest"}});o=await fetch("https://"+e+"/portal-migration/hz/glow/get-rendered-address-selections?deviceType=desktop&pageType=Gateway&storeContext=NoStoreName&actionSource=desktop-modal",{headers:{"X-OSA-Ext":"oa"+r,"anti-csrftoken-a2z":a.csrfGeo||"",accept:"text/html,*/*",referer:"https://"+e+"/",downlink:"10",origin:"","sec-fetch-site":"same-origin","sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-user":"","x-requested-with":"XMLHttpRequest"}});let i,s=(await o.text()).match(/CSRF_TOKEN.?:.?\"(.*?)\"/);s&&(i=s[1]);let c=z(e);n="https://"+e+"/gp/delivery/ajax/address-change.html";let d="application/x-www-form-urlencoded",u="locationType=LOCATION_INPUT&zipCode="+c+"&storeContext=generic&deviceType=web&pageType=Gateway&actionSource=glow&almBrandId=undefined";return n="https://"+e+"/portal-migration/hz/glow/address-change?actionSource=glow",d="application/json;charset=UTF-8",u=JSON.stringify({locationType:"LOCATION_INPUT",zipCode:c,storeContext:"",deviceType:"web",pageType:"Detail",actionSource:"glow"}),o=await fetch(n,{method:"POST",headers:{"X-OSA-Ext":"oa"+r,"anti-csrftoken-a2z":i,"content-type":d,accept:"text/html,*/*",referer:"https://"+e,downlink:"10",origin:"","sec-fetch-site":"same-origin","sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-user":"","x-requested-with":"XMLHttpRequest"},body:u}).catch(function(e){return console.log(e),e}),!0},z=function(e){var t=e.replace(/.*\.amazon\./,""),a={AE:"00000",COM:10001,CA:"M4B 1B3",CN:100001,IT:30149,IN:230532,DE:10115,FR:75003,ES:28005,BR:13010,SA:11564,SG:546080,CO_JP:"100-3131",CO_UK:"WC2N 5DU",COM_MX:"01080",COM_AU:2019,COM_BR:"28999-888",COM_TR:34083};return a[t=t.replace(".","_").toUpperCase()]?a[t]:a.COM},M=async function(e){var t=`o=add&a=${e.asin}&oid=${e.offerId}&verificationSessionID=${e.amzSessionId}&quantity=99999&ctaDeviceType=desktop&ctaPageType=detail&snsOnmlOfferId=&customId=&snsMerchantID=&snsOfferListingID=&snsAddressId=&coliid=&colid=&rcxOrdFreq=&snsOptIn=&snsMostCommonFrequency=&rebateId=&submit.add-to-cart=Add+to+cart`,a=`https://${e.host}/cart?a=${e.asin}&colid=&coliid=&ctaDeviceType=desktop&ctaPageType=detail&customId=&o=add&oid=${e.offerId}&quantity=99999&rcxOrdFreq=&rebateId=&redirectToFullPage=1&snsAddressId=&snsMerchantID=&snsMostCommonFrequency=&snsOfferListingID=&snsOnmlOfferId=&snsOptIn=&verificationSessionID=${e.amzSessionId}&_encoding=UTF8&ref_=mw_dp_buy_crt&submit.add-to-cart=Add+to+cart`;let r=await fetch(a,{method:"POST",headers:{"X-OSA-Ext":"oa"+e.sid,accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9","content-type":"application/x-www-form-urlencoded",origin:"",referer:"https://"+e.host+"/gp/aw/d/"+e.asin,"sec-fetch-dest":"document","sec-fetch-mode":"navigate","sec-fetch-site":"same-origin","sec-fetch-user":"?1","upgrade-insecure-requests":"1"},body:t}),n=await r.text();return L(n,e)},L=function(e,t){var a=(new DOMParser).parseFromString(e,"text/html");if("Robot Check"===$.trim(a.title))return{error:!0,data:"captcha"};if(a.querySelector("#warranty_info"))return{error:!0,data:"warranty"};var r=Array.from(a.querySelectorAll("input[name]")).filter(function(e){return e.getAttribute("name").startsWith("n:")}),n=a.querySelectorAll("div[data-asin]");if(r&&r.length>0&&r[0].value){var o=r[0].value;c=parseInt(o);var i=a.querySelector("a.itemTitle");if(i){var s=i.getAttribute("href")||"";d=(s.match(/\?m=(\w+)/)||[])[1]}return{error:!1,data:{qty:c,merchantId:d}}}if(n){var c,d,u=!1;if(Array.from(n).map(function(e){if(e.getAttribute("data-encoded-offering")===decodeURIComponent(t.offerId)){u=!0,c=e.getAttribute("data-quantity");var a=/smid=([A-Z0-9]+)/.exec(e.innerHTML);a&&(d=a[1].replace(/"/g,""))}}),!u)return{error:!0,data:"qty not found in the cart"};limitRE=new RegExp("(this seller has a limit|um limite de compra|verkoper geldt een limiet|presenta un limite di|vendedor tiene un límite de|お客様お一人あたり|Verkaufsbeschränkung|une limite de vente)");var l=!1;return e.match(limitRE)&&(l=!0),c?{error:!1,data:{qty:parseInt(c),offerId:t.offerId,merchantId:d,limit:l}}:{error:!0,data:"parsing error"}}return a.querySelector("div.sc-empty-cart")?{error:!0,data:"empty"}:{error:!0,data:"unknown"}},_=(e=0,t={},a={},{get:function(e){if(e.sid)return t[e.sid];if(e.key){var r=a[e.key];if(void 0===r)return;return t[r]}},add:function(r){var n=""+ ++e,o={sid:n,key:r};return t[n]=o,a[r]=n,o},clear:function(e){var r=e.key,n=a[r];delete t[n],delete a[r]},print:function(){console.log(t,a)}});return{init:function(){TaskManager.init({interval:200}),Errors.init({period:120,onLimitReached:function(){ChromePlatformAnalytics.sendEvent(["app","errorsLimitReached"]),TaskManager.updateInterval(1e3),clearTimeout(d),d=setTimeout(function(){TaskManager.updateInterval(200)},3e5)}}),u(),g(),m(),l(function(){S()})}}}();
App.init();