import{stockSession}from"../../../../constants/stockSessionIDs.js";import{STOCKCHECKEXT_SESSION_ID_HEADER}from"../../../../constants/sessionIdHeader.js";import{sessionCookies}from"../../../../constants/sessionCookies.js";const makeFetch=({request:s,isGettingSessionMask:o,isAddressChangeMask:t,sendResponse:n})=>{const r=s.input;s=new Request(s.input,s.init);fetch(s).then(e=>new Promise(s=>{o||t?setTimeout(()=>s(e),1e3):s(e)})).then(e=>{let t=[...e.headers].reduce((s,e)=>({...s,[e[0]]:e[1]}),{});var s;return o&&(s=sessionCookies["sessionID"],t={...t,sessionID:s}),e.text().then(s=>({headers:t,status:e.status,data:s}))}).then(s=>{try{var e=JSON.parse(s.data);s.json=e}catch(s){}return s.html=s.data,s}).then(s=>{var e;t&&(e=stockSession.IDs.find(s=>s.requestURL===r)?.sessionID,s.headers[STOCKCHECKEXT_SESSION_ID_HEADER]=e.trim(),stockSession.IDs=stockSession.IDs.filter(s=>s.requestURL!==r)),n(s)}).catch(s=>n({result:!1,errors:s.message}))};export{makeFetch};