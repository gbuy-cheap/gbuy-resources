"use strict";import{allResourceTypes,declarativeNetRequest,headerOperation,ruleActionType}from"../constants/declarativeNetRequestConstants.js";import{ruleNameIDs}from"../constants/ruleNameIDs.js";import{SAS_UB_ID_AMZ_MASK}from"../constants/urlMasks.js";import{netRequestAPI}from"./netRequestAPI.js";import{sentrySellerAmp}from"../../content/sentrySellerAmp/sentrySellerAmp.js";import{sessionCookies}from"../constants/sessionCookies.js";import{ubIdNames}from"../constants/ubIdNames.js";import{userAgent}from"../constants/userAgent.js";import{findCookieValue}from"./findCookieValue.js";import{findHeader}from"./findHeader.js";const addUbIDCookieHeader=()=>{SAS_UB_ID_AMZ_MASK.forEach(addHeaderToResponse)},addHeaderToResponse=e=>{chrome.webRequest.onCompleted.addListener(createHandler(),{urls:[e]},["responseHeaders","extraHeaders"])},createHandler=()=>e=>{sentrySellerAmp.wrap(function(){handleEvent(e)})},handleEvent=e=>{let r="com";var s=e.url.match(/https:\/\/www.amazon.([^\/]+)/),s="https://www.amazon."+(r=s?s[1]:r),t=ubIdNames[r],e=e.responseHeaders,a=findHeader(e,t)["header"];a&&addUBIDHeader({responseHeaders:e,origin:s,ubIdName:t})},addUBIDHeader=({responseHeaders:e,origin:r,ubIdName:s})=>{var e=findCookieValue(e,s);e&&(sessionCookies.value=""+sessionCookies.value+e,s=userAgent.value,e=[{operation:headerOperation.SET,header:"cookie",value:sessionCookies.value},{operation:headerOperation.SET,header:"Origin",value:r},{operation:headerOperation.SET,header:"User-Agent",value:s}],netRequestAPI.updateRequestHeaders({id:ruleNameIDs.setCookieOfChangingAddress,requestHeaders:e,urlFilter:"https://www.amazon*/portal-migration/hz/glow/address-change?actionSource=glow"}),netRequestAPI.updateRequestHeaders({id:ruleNameIDs.setCookieOfRenderedAddressSelections,requestHeaders:e,urlFilter:"https://www.amazon*/portal-migration/hz/glow/get-rendered-address-selections*"}),netRequestAPI.updateRequestHeaders({id:ruleNameIDs.setCookieOfGettingOffers,requestHeaders:e,urlFilter:"https://www.amazon*/gp/product/ajax/ref=dp_aod_NEW_mbc*"}),netRequestAPI.updateRequestHeaders({id:ruleNameIDs.setCookieOfGettingPrimeOffers,requestHeaders:e,urlFilter:"https://www.amazon*/gp/product/ajax/ref=aod_f_primeEligible*"}),declarativeNetRequest.updateDynamicRules({addRules:[{id:ruleNameIDs.setCookieOfAddingToCart,priority:1,action:{type:ruleActionType.MODIFY_HEADERS,requestHeaders:e},condition:{urlFilter:"https://data.amazon*/api/marketplaces/*/cart/carts/retail/items",resourceTypes:allResourceTypes}}]}))};export{addUbIDCookieHeader};