"use strict";import{declarativeNetRequest,headerOperation}from"../constants/declarativeNetRequestConstants.js";import{ruleNameIDs}from"../constants/ruleNameIDs.js";import{SAS_NEW_AMZ_MASK}from"../constants/urlMasks.js";import{netRequestAPI}from"./netRequestAPI.js";import{sentrySellerAmp}from"../../content/sentrySellerAmp/sentrySellerAmp.js";import{sessionCookies}from"../constants/sessionCookies.js";import{findCookieValue}from"./findCookieValue.js";import{findHeader}from"./findHeader.js";const addSessionIDCookieHeader=()=>{SAS_NEW_AMZ_MASK.forEach(addHeaderToResponse)},addHeaderToResponse=e=>{chrome.webRequest.onCompleted.addListener(createHandler(),{urls:[e]},["responseHeaders","extraHeaders"])},createHandler=()=>e=>{sentrySellerAmp.wrap(function(){handleEvent(e)})},handleEvent=e=>{declarativeNetRequest.updateDynamicRules({removeRuleIds:[ruleNameIDs.setCookieOfAddingToCart]});var e=e.responseHeaders,s=findHeader(e,"session-id")["header"];s&&addSessionIDHeader(e)},addSessionIDHeader=e=>{var s,o,r=findCookieValue(e,"session-id");r&&(r=r.replace("; ",""),sessionCookies.sessionID=r.replace("session-id=",""),s=findCookieValue(e,"session-id-time"),o=findCookieValue(e,"sp-cdn"),e=findCookieValue(e,"i18n-prefs"),sessionCookies.value=""+r+s+e+o,r=[{operation:headerOperation.SET,header:"cookie",value:sessionCookies.value}],netRequestAPI.updateRequestHeaders({id:ruleNameIDs.setCookieOfGettingUbID,requestHeaders:r,urlFilter:"https://www.amazon*/portal-migration/hz/glow/get-rendered-toaster*"}))};export{addSessionIDCookieHeader};