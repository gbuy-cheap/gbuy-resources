"use strict";import{jsFiles}from"../constants/jsFiles.js";import{cssFiles}from"../constants/cssFiles.js";import{IS_BETA_EXTENSION}from"../constants/gulpBetaExtensionFlag.js";import{MESSAGES}from"../constants/messages.js";import{checkAbilityOfInjection}from"./checkAbilityOfInjection.js";const{tabs:chromeTabs,scripting}=chrome,injectContentIntoTabs=()=>{setInterval(()=>{chromeTabs.query({active:!0,lastFocusedWindow:!0},async([e])=>{var t;e&&(t=e.url,checkAbilityOfInjection(t)&&changeTab(e.id),IS_BETA_EXTENSION)&&manageConflictsWithLegacyExtension(e)})},200)},manageConflictsWithLegacyExtension=t=>{chrome.tabs.sendMessage(t.id,{command:"getHTML"},function(e){e?.html&&(e=e.html.match(/<[^>]+id="SASContainer"[^>]*>/g))?.length&&e.forEach(e=>{e.indexOf("beta-extension")<0&&showAlertAndDisableItself(t)}),chrome.runtime.lastError&&console.log("Runtime Error")})},showAlertAndDisableItself=e=>{chrome.tabs.sendMessage(e.id,{command:"showAlert",title:MESSAGES.REMOVE_ANOTHER_VERSION_TITLE,message:MESSAGES.REMOVE_ANOTHER_VERSION},function(e){e?.isSent&&disableItself(),chrome.runtime.lastError&&console.log("Runtime Error")})},disableItself=()=>{chrome.management.setEnabled("kdjdiajopilediaadgkjijbcnegggpdd",!1,function(){chrome.runtime.lastError&&console.log("Error disabling extension: "+chrome.runtime.lastError.message)})},changeTab=async t=>{chromeTabs.query({},async e=>{e.filter(e=>Boolean(e.favIconUrl)).map(e=>e.id).includes(t)&&await sendMessageToTab(t)})},injectionTime={},sendMessageToTab=async n=>{chromeTabs.sendMessage(n,{command:"checkInjection"},async function(e){var t=chrome.runtime.lastError;!e&&t&&(4e3<(t=(e=(new Date).getTime())-(injectionTime[n]||e))||0==t)&&(injectionTime[n]=e,await injectContent(n))})},injectContent=async e=>{try{await scripting.executeScript({target:{tabId:e},files:jsFiles}),await scripting.insertCSS({target:{tabId:e},files:cssFiles})}catch(e){console.log(e)}};export{injectContentIntoTabs,changeTab};