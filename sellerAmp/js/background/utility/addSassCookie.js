"use strict";import{headerOperation}from"../constants/declarativeNetRequestConstants.js";import{ruleNameIDs}from"../constants/ruleNameIDs.js";import{generateRuleId}from"./generateRuleId.js";import{netRequestAPI}from"./netRequestAPI.js";import{stockSession}from"../constants/stockSessionIDs.js";import{cookieRuleIndex}from"../constants/cookieRuleIndex.js";import{sentrySellerAmp}from"../../content/sentrySellerAmp/sentrySellerAmp.js";import{findCookieValue}from"./findCookieValue.js";import{findHeader}from"./findHeader.js";import{SAS_NEW_SASS_MASK}from"../constants/urlMasks.js";const addSassCookie=()=>{SAS_NEW_SASS_MASK.forEach(addHeaderToResponse)},addHeaderToResponse=e=>{chrome.webRequest.onCompleted.addListener(createHandler(),{urls:[e]},["responseHeaders","extraHeaders"])},createHandler=()=>e=>{sentrySellerAmp.wrap(function(){handleEvent(e)})},handleEvent=e=>{var s=e.url,e=e.responseHeaders,o=findHeader(e,"session-id")["header"];o&&addSessionIDHeader(s,e)},addSessionIDHeader=(s,e)=>{var o=s.match(/https:\/\/www.amazon.+\/address-change.+sasRequestId=(.+)$/);if(o){var r=findCookieValue(e,"session-id").replace(";",""),a=findCookieValue(e,"session-id-time"),t=findCookieValue(e,"i18n-prefs"),e=findCookieValue(e,"sp-cdn");const d=r.replace("session-id=","");stockSession.IDs.find(e=>e.requestURL===s)?stockSession.IDs=stockSession.IDs.map(e=>e.requestURL===s?{...e,sessionID:d}:e):stockSession.IDs.push({requestURL:s,sessionID:d});var o=o[1],n=(cookieRuleIndex.value=cookieRuleIndex.value+1,cookieRuleIndex.value),n=generateRuleId(ruleNameIDs.setSassCookie,n),r=[{operation:headerOperation.SET,header:"cookie",value:""+r+a+t+e}];netRequestAPI.updateRequestHeaders({id:n,requestHeaders:r,urlFilter:"https://www.amazon*/gp/aw/c?*ssas*=*sass*sasRequestId="+o})}};export{addSassCookie};