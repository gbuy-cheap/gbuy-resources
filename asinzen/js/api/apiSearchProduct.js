const numberDelimiters={"www.amazon.com":{thousands:",",decimal:"."},"www.amazon.ca":{thousands:",",decimal:"."},"www.amazon.com.mx":{thousands:",",decimal:"."},"www.amazon.co.uk":{thousands:",",decimal:"."},"www.amazon.fr":{thousands:".",decimal:","},"www.amazon.de":{thousands:",",decimal:"."},"www.amazon.es":{thousands:".",decimal:","},"www.amazon.it":{thousands:".",decimal:","}},encodings={"+":"%2B","!":"%21",'"':"%22","#":"%23",$:"%24","&":"%26","'":"%27","(":"%28",")":"%29","*":"%2A",",":"%2C",":":"%3A",";":"%3B","=":"%3D","?":"%3F","@":"%40"},encodeS3URI=e=>encodeURI(e).replace(/(\+|!|"|#|\$|&|'|\(|\)|\*|\+|,|:|;|=|\?|@)/gim,(function(e){return encodings[e]})),searchProducts=async({domain:e,keyword:t,url:l})=>{try{l=l||`https://${e}/s?k=${encodeURIComponent(t)}`;const n=await fetch(l),a=await n.text(),r=(new DOMParser).parseFromString(a,"text/html"),s=r.querySelector(".s-main-slot.s-result-list.s-search-results.sg-row");if(!s)throw"No result";const i=s.querySelectorAll(":scope > .s-result-item.s-asin");if(!i.length)throw"No result";const o=[];for(let t=0;t<i.length;t++){const l=i[t],n=l.querySelectorAll("h2");let a="";n.length&&(a=n.length>1?n[0].innerText.trim()+" - "+n[1].innerText.trim():n[0].innerText.trim());let r=null,s=null,c="a-star-0",u=l.querySelector(".a-popover-trigger.a-declarative"),m=u?u.parentElement.parentElement.nextElementSibling:null;const{thousands:g,decimal:p}=numberDelimiters[e];if(u&&(r=u.querySelector(".a-icon-alt")&&Number(u.querySelector(".a-icon-alt").innerText.split(" ")[0].replace(new RegExp("\\"+g,"g"),"").replace(new RegExp("\\"+p,"g"),".").replace(/((?!\.)(?!\d).)/g,"")),r&&!isNaN(r))){r>5&&(r/=10);c="a-star-"+(Math.round(2*r)/2).toString().split(".").join("-")}if(m&&m){let e="";if(m.attributes["aria-label"])e=m.attributes["aria-label"].value;else{const t=m.querySelector("span");t&&t.attributes["aria-label"]&&(e=t.attributes["aria-label"].value)}e&&(s=e.replace(new RegExp("\\"+g,"g"),"").replace(new RegExp("\\"+p,"g"),"").replace(/((?!\.)(?!\d).)/g,""))}let d=null;const y=l.querySelector(".a-price-whole"),h=l.querySelector(".a-price-fraction");y&&h?d=Number([y.innerText.replace(/\D/g,""),h.innerText.replace(/\D/g,"")].join(".")):y&&(d=Number(y.innerText.replace(/\,/,".").replace(/((?!\.)(?!\d).)/g,"")));const f=l.querySelector(".s-image"),x={asin:l.attributes["data-asin"].value,title:a,rating:r,ratingClassName:c,review:s,price:d,image:f?f.src:null};o.push(x)}const c=r.querySelector(".a-pagination");let u=null,m=null;if(c){const e=c.querySelector(":scope > .a-selected"),t=e.nextElementSibling;t.classList.contains("a-disabled")||(u=t.querySelector("a").attributes.href.value);const l=e.previousElementSibling;l.classList.contains("a-disabled")||(m=l.querySelector("a").attributes.href.value)}return{data:o,next:u,prev:m}}catch(e){return console.log(e),{data:[],next:null,prev:null}}},apiGetAsinInfo=async({asin:e,currentUrl:t=!0,marketplaceConfig:l})=>{const{crawlLang:n,domain:a}=l||window.currentMarketplace2,r=`https://${a}/dp/${e}?th=1&psc=1&language=${n}`,s=await fetch(r),i=await s.text();return await getDataAnalytics((new DOMParser).parseFromString(unescape(i),"text/html"),e,{},!1,l)},getDataAnalytics=async(e,t,l,n,a)=>{try{const l=(e,t,l)=>{if(!0===l){const e=t&&t.filter&&t.filter(e=>{let t=e&&e.getElementsByTagName("th")&&e.getElementsByTagName("th")[0]||null,l=t&&t.textContent&&t.textContent.trim()||null;return null===l&&(t=e&&e.getElementsByTagName("td")||null,l=t&&t[0]&&t[0].textContent&&t[0].textContent.trim()||null),!(!l||!l.includes("Best Sellers"))}).map(e=>{let t=e&&e.getElementsByTagName("td")&&e.getElementsByTagName("td")[0]||null;t=t&&t.getElementsByTagName("span")&&t.getElementsByTagName("span")[0]||null,t=t&&t.getElementsByTagName("span")&&t.getElementsByTagName("span")[0]||null;let l=t&&t.textContent&&t.textContent.trim()||null;return null===l&&(t=e&&e.getElementsByTagName("td")||null,l=t&&t[1]&&t[1].textContent&&t[1].textContent.trim()||null),l})||null;t=e&&e[0]||null}const n=t&&t.trim()||null,a=n&&n.split(" in ")||null;if("rank"===e){let e=!1;if(a&&a[1]&&(e=0===(a[1].match(new RegExp(">","g"))||[]).length),!e)return null;let t=a&&a[0]||null;return t=t&&t.replace("#","")||null,t}if("category"===e){let e=!1;if(a&&a[1]&&(e=0===(a[1].match(new RegExp(">","g"))||[]).length),!e)return null;let t=a&&a[1]||null;if(!0===l){t=t&&t.split(" > ")[0]||null,t=t&&t.split(" (")||null;return t&&t[0]||null||t}return t=t&&t.replace(" (","")||null,t}},r=e;let s,i=null,o=null,c=null;a=a||window.currentMarketplace2;const{defineLanguage:u,amzCurrency:m,marketplace:g}=a;if(o||n||(i=e.getElementById("productDetails_detailBullets_sections1")||null,i=i&&i.getElementsByTagName("tr")||null,i=i&&Array.from(i)||null,null===i&&(i=e.getElementById("product-details-grid_feature_div")||null,i=i&&i.getElementsByTagName("tr")||null,i=i&&Array.from(i)||null),o=l("rank",i,!0)),c||(c=l("category",i,!0)),!o&&!n&&(i=e.getElementById("SalesRank")||null,i=i&&i.childNodes.item(2)||null,s=i&&i.textContent&&i.textContent.trim()||null,o=l("rank",s,!1),!o))if(i=e.getElementById("SalesRank")||e.querySelectorAll("#detailBulletsWrapper_feature_div > ul.detail-bullet-list")[0]||null,i||(i=e.getElementsByClassName("attrG"),i=i&&i[1]?i[1]:null),i||(i=e.querySelectorAll("#productDetails_detailBullets_sections1 tr")[2]||null,i=i&&i.querySelector("td")||null),i&&i.textContent.indexOf(u["See top"])>-1)i=i.childNodes[1].textContent.trim().split("("+u["See top"])[0].split(" "),o=i[0]||"",o=o.replace("#","").replace("nº",""),c=i[2]||"";else if(i&&i.textContent.indexOf(""+u["See Top"])>-1){if(i=i.childNodes[1].textContent||i.textContent,i=i.replace("Amazon Best Sellers Rank:","").replace("Clasificación en los más vendidos de Amazon","").trim(),i.indexOf("Best-sellers rank")>=0){const e=i.indexOf("Best-sellers rank");i=i.substr(e,i.length-e)}if(i=i.trim().split("("+u["See Top"])[0],i.indexOf(u.in)>=0?(i=i.split(u.in+" "),o=i[0]||"",o=o.trim(),c=i[1]||"",c=c.trim()):(i=i.split(" "),o=i[0]||"",c=i[2]||""),o&&o.indexOf("#")>=0){const e=o.indexOf("#");o=o.substr(e,o.length-e)}o=o.replace("#","").replace("nº","")}else{let e=i&&i.getElementsByTagName("ul")||null;e=e&&e[0]&&e[0].getElementsByTagName("li")||null,e=e&&e[0]&&e[0].getElementsByTagName("span")||null,s=e&&e[0]&&e[0].textContent&&e[0].textContent.trim()||null,o=s&&s.split("#")||null,o=o&&o[1]||null,e&&e[1]&&e[1].textContent.indexOf("MX"===g?"en ":"in ")&&(c=e[1].textContent.replace("in","").trim()),c||(e=i&&i.getElementsByTagName("li")||null,e=e&&e[0]&&e[0].getElementsByTagName("span")||null,s=e&&e[0]&&e[0].textContent&&e[0].textContent.trim()||null,o=s&&s.split("#")||null,o=o&&o[1]||null)}if(c||(s=i&&i.textContent?i.textContent.trim():null,c=l("category",s,!1)),!n){const l=e=>{const t=e.trim().indexOf(")")>=0,l=e.trim().replace(/(\s+)/g," ").replace(".zg_hrsr { margin: 0; padding: 0; list-style-type: none; }","").replace(".zg_hrsr_item { margin: 0 0 0 10px; }","").replace(".zg_hrsr_rank { display: inline-block; width: 80px; text-align: right; }","").replace("Clasificación en los más vendidos de Amazon","").replace(`(${u["See Top"]} 100`,"").replace("premiers","").replace("nella categoria","in").split(` ${u.in} `);return l.length<2?null:{rank:l[0].trim().replace(u.iconShart,"#"),category:t?l[1].trim():l[1].replace(" (","").trim()}},n=(t,n)=>{const a=[];if(1===n){let e=(t=(t=t.getElementsByClassName("zg_hrsr")||t)[0]||t)&&t.getElementsByClassName&&t.getElementsByClassName("zg_hrsr_item")||[];if(e=e.length>0?e:t&&t.getElementsByClassName&&t.getElementsByClassName("a-list-item")||[],e.length)for(let t=0;t<e.length;t++){const n=l(e[t].textContent);if(n){const l=e[t].querySelector("a");if(l){const e=l.href.split("/"),t=e[e.length-2];n.nodeId=t}a.push(n)}}}if(2===n){const t=e.querySelectorAll("#productDetails_detailBullets_sections1 > tbody > tr > td > span > span");for(let e=0;e<t.length;e++){const n=t[e].textContent,r=l(n);if(r){const l=t[e].querySelector("a");if(l){const e=l.href.split("/");if(8===e.length){const t=e[e.length-2];r.nodeId=t}else r.nodeId=null}a.push(r)}}}return a};if(!c){const{tmpRank:t,tmpCategory:l}=getCaterory(e,u);t&&(o=t),l&&(c=l)}c||(c=r.querySelector("#wayfinding-breadcrumbs_feature_div li span a"),c=c?c.textContent.trim():""),o=o?convertTxtToNumber(o.replace(/[^(\.\d)]+/g,"").replace(/[^(\,\d)]+/g,"")):0;let a=e.getElementById("SalesRank")||e.getElementById("detailBulletsWrapper_feature_div"),s=[];a&&(s=n(a,1),s.unshift({rank:"#"+o,category:c,nodeId:null})),a||(a=e.getElementById("productDetails_detailBullets_sections1"),a&&(s=n(a,2)));let i=e.getElementById("altImages");i=i?i.querySelectorAll("img"):[];const m=[];i.forEach(e=>{const t=e.getAttribute("src");/(.*)\.jpg$/.test(t)&&m.push({url:t.replace(/\._(.*)_\.jpg$/,".jpg")})});return{rank:o,ranks:uniqBy(s||[],"category"),category:c,asin:t}}return{}}catch(e){return console.log(e),{}}},getCaterory=(e,t)=>{try{let l=e.getElementById("SalesRank");l=l&&l.textContent.trim()||null,l=l&&l.split(t["See Top"])||null,l=l&&l[0]&&l[0].replace("Amazon Best Sellers Rank:","").replace("Clasificación en los más vendidos de Amazon","").trim().split(t.in)||[];const n=l[0]&&l[0].replace(t.iconShart,"").trim()||null;return{tmpRank:n,tmpCategory:l[1]&&l[1].replace("(","").trim()||null}}catch(e){console.log(e)}},convertTxtToNumber=e=>{if("number"==typeof e)return e<=0?0:e;return(e&&e.split&&e.split(",")||[]).map(()=>{e=e&&e.replace&&e.replace(",","")}),"string"==typeof e?parseFloat(e&&e.trim().replace("$","")||0):0},uniqBy=(e,t)=>{const l="function"==typeof t?t:e=>e[t];return[...e.reduce((e,t)=>{const n=null==t?t:l(t);return e.has(n)||e.set(n,t),e},new Map).values()]};chrome.runtime.onMessage.addListener((e,t,l)=>{const{query:n,payload:a}=e;return"AMZ_SEARCH_DATA"===n&&searchProducts(a).then(l),!0});