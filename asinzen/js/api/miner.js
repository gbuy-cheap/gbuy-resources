let sessionTabRunner={};const X_KEY="X-AZ-Ext",LIMIT=5,LIMIT_NUMBER_STOCK=10,listStoreContext=["toys-and-games","shoes","books","watches","grocery","apparel"],createFakeAsin=()=>{let e="Q";for(let t="ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890",a=0;a<9;a++)e+=t.charAt(Math.floor(Math.random()*t.length));return e},createUUID=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16).toUpperCase()}),randomNumberInt=(e,t)=>Math.ceil(Math.random()*(t-e-1)),randomNumber=(e,t)=>Math.floor(Math.random()*(t-e+1))+e,getRandomStoreContext=()=>{return listStoreContext[(e=0,t=listStoreContext.length,Math.ceil(Math.random()*(t-e-1)))];var e,t},randomString=(e,t)=>{t||(t="ABCDEFGHIJKLMNOPQRSTUVWXYZ");let a="";for(let n=0;n<e;n++){const e=Math.floor(Math.random()*t.length);a+=t.substring(e,e+1)}return a},getUA=()=>{const e=["Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/#6) AppleWebKit/#1.#2 (KHTML, like Gecko) Chrome/#3.0.#4.94 Mobile Safari/#1.#2","Mozilla/5.0 (Android; Mobile; rv:#1.#2) Gecko/#1.#2 Firefox/#1.#3","Mozilla/5.0 (Linux; Android 7.0; SM-#6 Build/NRD90M) AppleWebKit/#1.#2 (KHTML, like Gecko) Chrome/59.0.#3.#4 Mobile Safari/#1.#2","Opera/9.#3 (Android 4.1.2; Linux; Opera Mobi/ADR-#4#5) Presto/2.#1.#2 Version/12.#1","Mozilla/5.0 (Linux; U; Android 7.0; en-US; SM-#6 Build/NRD90M) AppleWebKit/#1.#2 (KHTML, like Gecko) Version/4.0 UCBrowser/11.3.#3.#4 U3/0.8.0 Mobile Safari/#1.#2","Mozilla/5.0 (Linux; Android 6.0.1; SM-#6 Build/MMB29K) AppleWebKit/#1.#2 (KHTML, like Gecko) Chrome/#3.0.#4.#5 Mobile Safari/#1.#2","Mozilla/5.0 (Linux; Android 7.0; SAMSUNG SM-#6 Build/NRD90M) AppleWebKit/#1.#2 (KHTML, like Gecko) SamsungBrowser/5.4 Chrome/#3.0.#4.#5 Mobile Safari/#1.#2","Mozilla/5.0 (Linux; Android 6.0; Lenovo #6 Build/MRA58K) AppleWebKit/#1.#2 (KHTML, like Gecko) Chrome/61.0.#3.#4 YaBrowser/17.4.1.#5.00 Mobile Safari/#1.#2"];let t=e[Math.floor(Math.random()*e.length)];return[randomNumber(501,537),randomNumber(1,37),randomNumber(50,80),randomNumber(1e3,7e3),randomNumber(1e3,7e3),randomString(6)].map((e,a)=>{const n=new RegExp("#"+(a+1),"g");t=t.replace(n,e)}),t},checkHeaderHasKey=(e,t)=>{for(let a=0,n=e.length;a<n;a++)if(e[a].name.toLowerCase()===t.toLowerCase())return a;return-1},findIndexHeader=(e,t)=>{for(let a=0,n=e.length;a<n;a++)if(e[a].name.toLowerCase()===t.toLowerCase())return a;return-1},getHost=e=>{const t=document.createElement("a");return t.href=e,t.host},addHeaders=(e,t,a)=>{const n=findIndexHeader(e,t);n>=0?e[n].value=a:e.push({name:t,value:a})},combineCookies=e=>{const t=[];for(const a in e)t.push(`${a}=${e[a]}`);return t.join("; ")},getCookieValue=function(e,t){for(let a=0;a<e.length;a++){const n=e[a];if(n[0].toLowerCase()===t.toLowerCase())return n[1]}return null},beforeRequest=e=>{const t=e.requestHeaders,a=new URL(e.url),n=new URLSearchParams(a.search);let r=null;if(n.get("az-stock")&&n.get("az-tab-id")){for(r=n.get("az-tab-id"),d=0;d<t.length;++d){var s=t[d].name.toLowerCase();("cookie"==s||"sec-fetch-dest"==s||"sec-fetch-mode"==s||"sec-fetch-user"==s||"accept"==s||"referer"==s)&&t.splice(d--,1)}if(sessionTabRunner[r]&&sessionTabRunner[r].cookie){cookies=[];const e=sessionTabRunner[r].cookie;for(let t=0;t<e.length;t++)cookies[t]=`${e[t][0]}=${e[t][1]}`;t.push({name:"Cookie",value:cookies.join("; ")})}return{requestHeaders:t}}},afterRequest=e=>{const t=new URL(e.url),n=new URLSearchParams(t.search),r=n.get("az-c"),s=n.get("az-tab-id");if("1"===r){const t=e.responseHeaders,n=[];for(a=0;a<t.length;++a)"set-cookie"==t[a].name.toLowerCase()&&(parseCookieHeader(n,t[a].value),t.splice(a,1),a--);return sessionTabRunner[s].cookie=sessionTabRunner[s].cookie||[],sessionTabRunner[s].cookie=[...sessionTabRunner[s].cookie,...n],{responseHeaders:t}}},parseCookieHeader=function(e,t){c=t.replace(/;\s+/g,";");const a=c.split(";");for(let t=0;t<a.length;t++){const n=a[t].split("=");e.push([n[0],n[1]])}},setup=()=>{const e={urls:[],types:["xmlhttprequest"]};["*://www.amazon.ae/*","*://www.amazon.com/*","*://www.amazon.co.uk/*","*://www.amazon.es/*","*://www.amazon.nl/*","*://www.amazon.mx/*","*://www.amazon.it/*","*://www.amazon.in/*","*://www.amazon.de/*","*://www.amazon.fr/*","*://www.amazon.cn/*","*://www.amazon.ca/*","*://www.amazon.sa/*","*://www.amazon.sg/*","*://www.amazon.com.au/*","*://www.amazon.com.br/*","*://www.amazon.com.mx/*","*://www.amazon.com.tr/*","*://www.amazon.co.jp/*"].map(t=>{e.urls.push(t),e.urls.push(t.replace("www","smile")),e.urls.push(t.substring(0,t.length-1)+"ref=nav_logo"),e.urls.push(t+"gp/offer-listing/*"),e.urls.push(t.replace("www","smile")+"gp/offer-listing/*"),e.urls.push(t+"gp/delivery/ajax/address-change.html"),e.urls.push(t.replace("www","smile")+"gp/delivery/ajax/address-change.html/*"),e.urls.push(t+"gp/aw/c*"),e.urls.push(t+"gp/aw/c/"),e.urls.push(t.replace("www","smile")+"gp/aw/c/*"),e.urls.push(t+"gp/item-dispatch*"),e.urls.push(t.replace("www","smile")+"gp/item-dispatch*"),e.urls.push(t+"cart?*"),e.urls.push(t+"cart/*"),e.urls.push(t.replace("www","smile")+"cart?*"),e.urls.push(t+"gp/cart/ajax-update.html*"),e.urls.push(t+"gp/cart/ajax-update.html/*"),e.urls.push(t+"gp/glow/get-address-selections.html*"),e.urls.push(t.replace("www","smile")+"gp/cart/ajax-update.html*"),e.urls.push(t+"portal-migration/hz/glow/address-change*"),e.urls.push(t.replace("www","smile")+"portal-migration/hz/glow/address-change*")}),chrome.webRequest.onBeforeSendHeaders.addListener(beforeRequest,e,["blocking","requestHeaders","extraHeaders"]),chrome.webRequest.onHeadersReceived.addListener(afterRequest,e,["blocking","responseHeaders","extraHeaders"]),sessionTabRunner={}},delay=e=>new Promise(t=>setTimeout(t,e)),handleChangeLocation=async(e,t,a,n)=>{try{return await fetch(`https://${e}/portal-migration/hz/glow/address-change?actionSource=glow&az-tab-id=${n}&az-stock=change-location&az-c=1`,{headers:{authority:e,accept:"text/html,*/*","content-type":"application/json","anti-csrftoken-a2z":sessionTabRunner[n].csrfToken},method:"post",body:a?JSON.stringify(a):JSON.stringify({locationType:"LOCATION_INPUT",zipCode:t,storeContext:"grocery",deviceType:"web",pageType:"Detail",actionSource:"glow"})}),!0}catch(e){return!1}},handleRequestToAMZ=async(e,t)=>{try{return await fetch(`https://${e}/ref=nav_logo`,{headers:{accept:"text/html,*/*",[X_KEY]:"oa"+t.id},credentials:"include",method:"get"}).then(()=>!0)}catch(e){return!1}},handleSession=async e=>{try{const t=await fetch(`https://${e.configMarketplace.domain}/amazonprime?az-stock=new-session&az-tab-id=${e.tabId}&az-c=1`).then(e=>e.text()),a=(new DOMParser).parseFromString(t,"text/html").querySelector("#nav-global-location-data-modal-action");if(a){const t=a.getAttribute("data-a-modal"),n=JSON.parse(t);if(n&&n.ajaxHeaders){e.addressSelectionHeaders=n.ajaxHeaders;const t=await fetch(`https://${e.configMarketplace.domain}/portal-migration/hz/glow/get-rendered-address-selections?deviceType=desktop&pageType=Gateway&storeContext=NoStoreName&actionSource=desktop-modal&az-tab-id=${e.tabId}&az-stock=address-selection&az-c=1`,{headers:{...n.ajaxHeaders}}).then(e=>e.text()).then(e=>e).catch(e=>!1);if(t){const a=t.indexOf('CSRF_TOKEN : "')+'CSRF_TOKEN : "'.length,n=t.indexOf('"',a);e.csrfToken=t.substr(a,n-a)}}}return!0}catch(e){console.log(e)}},updateUserLocation=async e=>{const{configMarketplace:t,tabId:a}=e;return await handleChangeLocation(t.domain,t.location,t.changeAddressBody,a)},CompareTextStock=e=>e.indexOf("left in stock (more on the way)")>=0&&e.indexOf("Only")>=0?(e=e.replace("Only ","").replace(" left in stock (more on the way).",""),e=Number(e)):e.indexOf("left in stock - order soon")>=0&&e.indexOf("Only")>=0&&(e=e.replace("Only ","").replace(" left in stock - order soon",""),e=Number(e)),DetectQuantityCaseOne=(e,t)=>{const a=`${e.asin}?m=${e.merchantId}`;let n=t.querySelector(`a[href="/gp/aw/d/${a}"]`);if(n=n?n.getAttribute("name"):null,n=n?n.substring(1,n.length):null,!n)return!1;let r=t.querySelector(`input[name="n:${n}"]`),s=r?r.value:0;for(let e=0;e<4;e++)r=r&&r.nextElementSibling||null;r&&r.textContent&&(r=r.textContent||"",r=CompareTextStock(r),!1!==r&&(s=s!==r?r:s));let o=t.querySelectorAll("a");return o=Array.from(o),o=o.filter(e=>!!e.getAttribute("href")&&e.getAttribute("href").indexOf(`i=${n}&o=delete`)>=0),o=o[0]?o[0].getAttribute("href"):null,{listAnchorText:o,quantity:s}},DetectQuantityCaseTwo=(e,t)=>{let a=t.querySelector(`div[data-encoded-offering="${decodeURIComponent(e.offerId)}"]`);if(!a)return!1;let n=a&&a.querySelector(".sc-product-scarcity")||null,r=a&&a.getAttribute("id")||null,s=a?a.querySelector('input[name="quantityBox"]'):null;return!!s&&(n=n&&n.textContent||null,r=r&&r.replace("sc-item-","")||"",s=s&&s.getAttribute("value")||0,s||(s=a.querySelector("span a.a-size-medium.a-link-normal")||null,s=s&&s.textContent||0,s=s&&Number(s)||0),s||(s=a.querySelector(`div[data-itemid="${r}"]`)||null,s=s&&s.querySelector('input[aria-label="Quantity"]')||null,s=s&&s.value||0),s||(s=a.querySelector(".sc-action-quantity .sc-non-editable-quantity-right")||null,s=s&&s.textContent&&s.textContent.trim().replace("Qty:","")||null,s=Number(s)||0),n=!!n&&CompareTextStock(n),!1!==n&&(s=s!==n?n:s),s||(s=a.querySelector('.sc-action-quantity[data-action="quantity"] input'),s=s?s.getAttribute("value"):0),!!r&&{quantity:s})},RemoveCartCaseOne=async(e,t,a)=>{const n=`${t.asin}?m=${t.merchantId}`;let r=a.querySelector(`a[href="/gp/aw/d/${n}"]`);if(r=r?r.getAttribute("name"):null,r=r?r.substring(1,r.length):null,!r)return!1;let s=a.querySelectorAll("a");s=Array.from(s),s=s.filter(e=>!!e.getAttribute("href")&&e.getAttribute("href").indexOf(`i=${r}&o=delete`)>=0),s=s[0]?s[0].getAttribute("href"):null;const o=`https://${e.domain}${s}`;return await fetch(o,{method:"GET",pragma:"no-cache",headers:{[X_KEY]:"oa"+t.id}}).then(()=>!0).catch(e=>(console.log("debug error",e),console.log("error remove from cart "+e.message),!1))},RemoveCartCaseThree=async(e,t,a)=>{try{let n=t.querySelector("#activeCartViewForm")||null,r=null;if(n?r=n:(n=t.querySelector(`div[data-asin="${a.asin}"]`)||t.querySelector("div[data-asin]")||null,r=n?n.parentNode:null,r=r?r.parentNode:null),!n)return!1;const s=new URLSearchParams;let o=r.querySelector('input[name="requestID"]')||r.querySelector("input[name='requestID']");o=o?o.value:null;let i=r.querySelector('input[name="timeStamp"]')||r.querySelector("input[name='timeStamp']");i=i?i.value:null;let c=r.querySelector('input[name="token"]')||r.querySelector("input[name='token']");c=c?c.value:null,n.hasAttribute("data-asin")||(n=n.querySelector(`div[data-asin="${a.asin}"]`)||n.querySelector("div[data-asin]")||null);const l=n.getAttribute("data-encoded-offering");let d=n.getAttribute("id");return d=d.replace("sc-item-",""),s.append("submit.delete."+d,1),s.append("pageAction","delete-active"),s.append("actionItemID",d),s.append("actionType","delete"),s.append("asin",a.asin),s.append("encodedOffering",l),s.append("displayedSavedItemNum",0),s.append("timeStamp",i),s.append("token",c),s.append("requestID",o),await fetch(`https://${e.domain}/gp/cart/ajax-update.html/ref=ox_sc_cart_delete_1`,{method:"POST",pragma:"no-cache",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8;",[X_KEY]:"oa"+a.id},body:s}).then(()=>!0).catch(e=>(console.log("error remove case 3:  "+e.message),!1))}catch(e){console.log(e)}return!1},DetectQuantity=async(e,t,a)=>{let n=!1;if(n=t.indexOf("Important messages about items in your Cart")>=0||t.indexOf("sc-active-cart")>=0||e.querySelector(`div[data-asin="${a.asin}"]`)?DetectQuantityCaseTwo(a,e):DetectQuantityCaseOne(a,e),!n)return{};const{quantity:r}=n;return{quantity:r}},QueryToCart=async(e,t,a)=>{const n=`https://${e.domain}/gp/aw/c/?az-stock=query-to-cart&az-tab-id=${a}`;return await fetch(n,{headers:{pragma:"no-cache",accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9",[X_KEY]:"oa"+t.id}}).then(async e=>await e.text()).catch(e=>(console.log(e),!1))},RequestUpdateCart=async(e,t,a)=>{if(!t)return!1;let n=t.querySelector("input[name='token']");n=n?n.getAttribute("value"):null;let r=t.querySelector("input[name='timeStamp']");r=r?r.getAttribute("value"):null;let s=t.querySelector("input[name='requestID']");s=s?s.getAttribute("value"):null;const o=t.querySelector(`div[data-asin="${a.asin}"]`),i=o?o.getAttribute("data-itemid"):null;if(!n||!i)return!1;const c=new URLSearchParams;c.append("submit.cart-actions","1"),c.append("pageAction","cart-actions"),c.append("actionPayload",JSON.stringify([{type:"DELETE_START",payload:{itemId:i,list:"activeItems",relatedItemIds:[],isPrimeAsin:!1}}])),c.append("hasMoreItems",!1),c.append("timeStamp",r),c.append("token",n),c.append("requestID",s),c.append("addressId",""),c.append("addressZip",""),c.append("closeAddonUpsell",1),c.append("displayedSavedItemNum",0),c.append("redirectToFullPage",1);const l=`https://${e.domain}/cart/ref=ox_sc_cart_actions_1`;return await fetch(l,{method:"POST",pragma:"no-cache",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",accept:"application/json, text/javascript, */*; q=0.01",[X_KEY]:"oa"+a.id},body:c}).then(e=>e.text()).then(e=>e.toLowerCase().indexOf("this seller has a limit of")>=0||e.toLowerCase().indexOf("este vendedor tiene un límite de")>=0).catch(()=>!1)},DetectRemoveCart=async(e,t,a,n)=>{const r="object"==typeof t?t:(new DOMParser).parseFromString(t,"text/html"),s=r.querySelector(`div[data-asin="${a.asin}"]`),o=new RegExp("(this seller has a limit|um limite de compra|verkoper geldt een limiet|presenta un limite di|vendedor tiene un límite de|お客様お一人あたり|Verkaufsbeschränkung|une limite de vente)"),i=t.match(o),c=await DetectQuantity(r,t,a);if(c&&"string"==typeof c.quantity&&(c.quantity=Number(c.quantity)),s&&!a.price){const e=s.getAttribute("data-price")||null;e&&(a.price=Number(e))}return{...a,...c||{},hasSetLimit:i&&i.length?"Yes":""}},AddToCart=async(e,t,a,n=0)=>{try{if(!sessionTabRunner[e])return t;const n=window.listMarketplaces[a.domain];a.xClientId="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16).toUpperCase()});const r=new URLSearchParams;r.append("o","add"),r.append("a",t.asin),r.append("oid",decodeURIComponent(t.offerId)),r.append("verificationSessionID",sessionTabRunner[e].sessionId),r.append("quantity","99999"),r.append("ctaDeviceType","desktop"),r.append("ctaPageType","detail"),r.append("submit.add-to-cart","Add to cart"),r.append("snsOnmlOfferId",""),r.append("customId",""),r.append("snsMerchantID",""),r.append("snsOfferListingID",""),r.append("snsAddressId",""),r.append("coliid",""),r.append("colid",""),r.append("rcxOrdFreq",""),r.append("snsOptIn",""),r.append("snsMostCommonFrequency",""),r.append("rebateId","");const s=`https://${n.domain}/cart?a=${t.asin}&colid=&coliid=&ctaDeviceType=desktop&ctaPageType=detail&customId=&o=add&oid=${t.offerId}&quantity=99999&rcxOrdFreq=&rebateId=&redirectToFullPage=1&snsAddressId=&snsMerchantID=&snsMostCommonFrequency=&snsOfferListingID=&snsOnmlOfferId=&snsOptIn=&verificationSessionID=${sessionTabRunner[e].sessionId}&_encoding=UTF8&ref_=mw_dp_buy_crt&submit.add-to-cart=Add+to+cart&az-tab-id=${e}&az-stock=add-to-cart`;let o=await fetch(s,{method:"POST",pragma:"no-cache",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-Client-ID":a.xClientId,[X_KEY]:"oa"+t.id,origin:"","sec-fetch-dest":"document","sec-fetch-mode":"navigate","sec-fetch-site":"same-origin","sec-fetch-user":"?1","upgrade-insecure-requests":"1"},body:r}),i=await o.text();const c="object"==typeof i?i:(new DOMParser).parseFromString(i,"text/html");return c.querySelector(`div[data-encoded-offering="${decodeURIComponent(t.offerId)}"]`)||(o=await fetch(s,{method:"POST",pragma:"no-cache",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-Client-ID":a.xClientId,[X_KEY]:"oa"+t.id,origin:"","sec-fetch-dest":"document","sec-fetch-mode":"navigate","sec-fetch-site":"same-origin","sec-fetch-user":"?1","upgrade-insecure-requests":"1"},body:r}),i=await o.text()),await DetectRemoveCart(0,i,t)}catch(e){return e.response&&503===e.response.status?{...t,isLock:!0}:t}},createStockFrame=(e,t)=>{if(sessionTabRunner[e])for(let t=0;t<sessionTabRunner[e].cookie.length;t++){const a=sessionTabRunner[e].cookie[t];if("session-id"===a[0].toLowerCase()){sessionTabRunner[e].sessionId=a[1];break}}return t},getListQuantity=async({tabId:e,params:t,limit:a=0})=>{if(!sessionTabRunner[e]||a>5)return;sessionTabRunner[e].cookie||(await handleSession(sessionTabRunner[e]),await updateUserLocation(sessionTabRunner[e]),await delay(500));const n=sessionTabRunner[e].data.splice(0,10);if(n.length>0){const r=n.map(t=>createStockFrame(e,t)),s=[];if(await r.reduce(async(a,n)=>{try{await a,await delay(100);const r=await AddToCart(e,n,t);return s.push(r),!0}catch(e){return console.log(e),!1}},Promise.resolve()),s.length>0){chrome.tabs.sendMessage(e,{query:"resultStockQuantity",payload:s});s.filter(e=>e.quantity).length>0&&(a=0)}const o=s.filter(e=>!e.quantity);o.length>0&&sessionTabRunner[e]&&(sessionTabRunner[e].data=[...sessionTabRunner[e].data,...o]),sessionTabRunner[e]&&sessionTabRunner[e].data.length>0?(await delay(250),getListQuantity({tabId:e,params:t,limit:a+1})):delete sessionTabRunner[e]}},pushDataToQueue=({data:e,tabId:t,params:a,queryUrl:n,configMarketplace:r})=>{sessionTabRunner[t]||(sessionTabRunner[t]={tabId:t,data:[],params:a,queryUrl:n,status:!1,cookie:null,sessionId:null,crfsToken:null}),sessionTabRunner[t].data=sessionTabRunner[t].data.concat(e),sessionTabRunner[t].params=a,sessionTabRunner[t].queryUrl=n,sessionTabRunner[t].configMarketplace=r,getListQuantity(sessionTabRunner[t])},getTabId=(e,t)=>{const a=e.queryUrl.indexOf("#");let n=e.queryUrl;a>0&&(n=e.queryUrl.substring(0,a)),chrome.tabs.query({url:n},e=>{e&&(sessionTabRunner[e[0].id]={tabId:e[0].id,data:[],params:{},queryUrl:"",status:!1},t(e[0].id))})},checkTabRun=()=>{const e=Object.keys(sessionTabRunner);let t=null;for(let a=0,n=e.length;a<n;a++)if(sessionTabRunner[e[a]]&&!1===sessionTabRunner[e[a]].status){t=sessionTabRunner[e[a]];break}t&&getListQuantity({tabId:t.tabId,params:t.params})};chrome.runtime.onMessage.addListener(async(e,t,a)=>{const{query:n,payload:r}=e;if("requestGetQuantity"===n)a(await AddToCart(r));else if("requestGetListQuantity"===n){const e=window.listMarketplaces[r.params.domain];pushDataToQueue({...r,configMarketplace:e})}else"getTabId"===n?getTabId(r,a):"unLockSession"===n?(delete sessionTabRunner[r.tabId],a()):"reinstallWebRequest"===n&&setup()}),setup();