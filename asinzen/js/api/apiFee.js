const getCalculatorIndex=async({domain:e})=>{try{const t=window.listMarketplaces[e],n=await fetch(`${t.sellerCentralUrl}/fba/revenuecalculator/index?lang=${t.lang}`);if(n&&200===n.status){const e=await n.text();let t=(new DOMParser).parseFromString(unescape(e),"text/html");return t=t.querySelector('input[name="profitcalcToken"]')||null,t=t&&t.getAttribute("value")||null,t}return null}catch(e){return null}},searchSellerCentralProduct=async(e,t,n)=>{try{const a=await fetch(`${e.sellerCentralUrl}/fba/revenuecalculator/productmatches?searchKey=${n}&searchType=keyword&profitcalcToken=${t}&lang=${e.lang}&language=${e.lang}`),i=await a.json();return"true"===i.succeed&&i.data?i.data[0]:{}}catch(e){return{}}},apiGetFeeInfo=async e=>{const{asin:t,fba:n,mfn:a,domain:i,noSizeWeight:r}=e,l=window.listMarketplaces[i],{currency:s,weightUnit:o,weightUnitString:c,dimensionUnit:g,dimensionUnitString:h,marketPlaceId:u,marketplace:f}=l;let d=null,F={},p="success";try{if(d=await getCalculatorIndex(e),!d)throw"No token found";F=await searchSellerCentralProduct(l,d,t)}catch(e){console.log("search product",e),p="error"}F={...F,weightUnit:o,weightUnitString:c,dimensionUnit:g,dimensionUnitString:h};let m=e.length||F.length,w=e.width||F.width,S=e.height||F.height,y=e.weight||F.weight;F={...F,height:S,length:m,weight:y,width:w};const T={sizeInfo:{},sizeTiers:null,shippingWeight:0,afnFees:{referFee:0,closingFee:0,fullfillmentFee:0,storageFee:0},mfnFees:{referFee:0,closingFee:0},packageDimensions:{height:S,length:m,weight:y,width:w,type:"calculator"}};if(r&&(m=10,w=10,S=10,y=10),S&&m&&y&&w){if(!r){if("US"===f||"CA"===f){const e=handleForSizeTiersAndWeight(y,w,m,S,f),t=handleGetSizeTiers(e,f),n=handleGetShippingWeight(e,t,f);T.sizeInfo=e,T.sizeTiers=t,T.shippingWeight=n}if(-1!==["UK","DE","FR","IT","ES"].indexOf(f)){const{sizeTiers:e,shippingWeight:t}=getSizeTierUK({height:S,length:m,weight:y,width:w});T.sizeTiers=e,T.shippingWeight=t}if("MX"===f){const{sizeTiers:e,shippingWeight:t}=getSizeTierMX({weight:y,width:w,length:m,height:S});T.sizeTiers=e,T.shippingWeight=t}}if(d){const e={productInfoMapping:F,afnPriceStr:parseFloat(n,10),mfnPriceStr:parseFloat(a,10),mfnShippingPriceStr:0,currency:s,marketPlaceId:u,hasFutureFee:!1,futureFeeDate:simpleFormatDate(),hasTaxPage:!0},t={method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrer:"no-referrer",body:JSON.stringify(e)};let i={};try{if(i=await fetch(`${l.sellerCentralUrl}/fba/revenuecalculator/getafnfee?profitcalcToken=${encodeURI(d)}&lang=${l.lang}&language=${l.lang}`,t),200!==i.status&&201!==i.status)throw"Bad Request";i=await i.json()}catch(e){p="error",console.log("get fee",e)}const{afnFees:o,mfnFees:c}=i.data||{afnFees:{},mfnFees:{}};r||(T.afnFees.referFee=o.referralFee&&o.referralFee.amount||0,T.afnFees.closingFee=o.variableClosingFee&&o.variableClosingFee.amount||0,T.afnFees.fullfillmentFee=(o.pickAndPackFee?o.pickAndPackFee.amount:0)+(o.weightHandlingFee?o.weightHandlingFee.amount:0)+(o.orderHandlingFee?o.orderHandlingFee.amount:0),T.afnFees.storageFee=o.storageFee&&o.storageFee.amount||0),T.mfnFees.referFee=c.referralFee&&c.referralFee.amount||0,T.mfnFees.closingFee=c.variableClosingFee&&c.variableClosingFee.amount||0}else p="error"}return T.feeStatus=p,T};chrome.runtime.onMessage.addListener(({query:e,payload:t})=>{"initCalculator"===e&&getCalculatorIndex(t)}),chrome.runtime.onMessage.addListener((e,t,n)=>{const{query:a,payload:i}=e;return"profitabilitycalculator"===a&&apiGetFeeInfo(i).then(n).catch(e=>{console.log(e),n()}),!0});