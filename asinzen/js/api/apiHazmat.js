chrome.runtime.onMessage.addListener(async(e,t,a)=>{const{query:n,params:r}=e;if("checkHazMat"===n){try{const e=window.listMarketplaces[r.domain];let t=await checkHazmatNewVersion(e,r.asin,r.marketplace);(!t||"ANOTHER"===t||"object"==typeof t&&"ANOTHER"===t.hazmatCondition)&&(t=await checkHazmatOldVersion(e,r.asin,r.marketplace)),a(t)}catch(e){a(null)}return!0}});const getHazmatParamsForMarketplace=e=>{let t="NA";return-1!==["UK","DE","FR","IT","ES"].indexOf(e)&&(t="EU"),`stck=${t}&sif_profile=SXAugurExecuteWorkflowParams${t}`},checkHazmatNewVersion=async(e,t,a)=>{try{return await findHazRunId(e,t,a).then(getFormInputAsin).then(submitAsin).then(handleResultHazmat)}catch(e){return null}},checkHazmatOldVersion=async(e,t,a)=>{try{return await findHazRunId(e,t,a).then(getFormInputAsinOld).then(submitAsinOld).then(handleResultHazmat)}catch(e){return console.log(e),null}};chrome.runtime.onMessage.addListener((e,t,a)=>{const{query:n,payload:r}=e;if("checkLoginSellerCentral"===n)return apiCheckLoginSellerCentral(r).then(a).catch(()=>{a(!1)}),!0});const handleResultHazmat=async({asin:e=null,data:t=null,marketplace:a,hazDiagRunId:n=null,configMarketplace:r=null})=>{if(!e||!t)return null;const i=(new DOMParser).parseFromString(t,"text/html");let l=i.querySelector(".workflow_title")||null;l=l&&l.innerText||null;let s=i.querySelector(".diag_state")||null;if(s=s&&s.innerText||null,!l&&!s)return"ANOTHER";let o="",u="";return 0===l.trim().length&&0===s.trim().length&&(o="UNCLASSIFIED",u="No hazmat status for this ASIN from Amazon"),s&&(s.indexOf("An error occurred. Please try again")>=0||s.indexOf("under review")>=0||s.indexOf("This product is under dangerous goods review")>=0?(o="UNDER_REVIEW",u="<div>This product is under review.</div>"):s.indexOf("We are unable to classify this ASIN")>=0||s.indexOf("We were unable to classify this ASIN")>=0?(o="UNCLASSIFIED",u=`<div>${outerHTML(i.querySelector(".diag_state"),!0)} <div>Note: This does not mean you can not sell this ASIN as FBA. If this is a parent ASIN, please select a child ASIN</div> </div>`):s.indexOf("This product is not dangerous goods")>=0?(o="NOT_HAZMAT",u=outerHTML(i.querySelector(".diag_state"),!0)):s.indexOf("We need more information")>=0||s.indexOf("Upload SDS or exemption sheet")>=0?(o="NEED_MORE_INFO",u=outerHTML(i.querySelector(".diag_state"),!0)):(s.indexOf("This product is dangerous goods")>=0||s.indexOf("This product is a dangerous good")>=0)&&(s.indexOf("Per Amazon polic")>=0||s.indexOf("per Amazon policy")>=0?o="HAZMAT_NOT_SOLD":(s.indexOf("This product is classified as dangerous goods but you can still sell through FBA")>=0||s.indexOf("This product is classified as dangerous goods, but you can still sell through FBA")>=0||s.indexOf("Inventory will be in Reserved status while in transit, which takes up to 14 business days")>=0||s.indexOf("Inventory will be in Reserved status while in transit, which takes up to 14 working days")>=0||s.indexOf("It can be fulfilled by Amazon if you are")>=0)&&(o="HAZMAT"),u=outerHTML(i.querySelector(".diag_state"),!0))),await cancelAndRestart({hazDiagRunId:n,marketplace:a,configMarketplace:r}),{hazmatCondition:o||"ANOTHER",hazmatInfo:u||"No hazmat status for this ASIN from Amazon"}},outerHTML=e=>{const t=e.querySelector(".a-spacing-top-mini.a-fixed-right-grid-col.a-col-left")||null;t&&(t.style.float="unset");const a=document.createElement("div");return a.appendChild(e.cloneNode(!0)),a.innerHTML},submitAsin=({asin:e=null,hazDiagRunId:t=null,marketplace:a,configMarketplace:n})=>{if(axios.default.withCredentials=!0,!e||!t)return null;const r=`workflowId=fba_dangerous_goods&requiredAttributes%5B%5D=item_id&requiredAttributes%5B%5D=obtain_asin_blurb&requiredAttributes%5B%5D=continue_task_18ie4by&currentStepName=obtain_asin_task_18ie4by&sxaugur.encrypt.newAttributes=%7B%22continue_task_18ie4by%22%3A%22true%22%2C%22item_id%22%3A%22${e}%22%7D&diagRunId=${t}&client=FullPageHelp&paramountEphUser=undefined&paramountEphUuid=undefined&isResumingWorkflow=false`;return axios({method:"post",url:`${n.sellerCentralUrl}/help/workflow/execute-workflow?mons_sel_persist=false&${getHazmatParamsForMarketplace(a)}`,data:r,headers:{pragma:"no-cache","accept-language":"en,ko;q=0.9,vi;q=0.8,cs;q=0.7","content-type":"application/x-www-form-urlencoded",accept:"application/json, text/plain, */*","cache-control":"no-cache",authority:"sellercentral.amazon.com","x-requested-with":"XMLHttpRequest"}}).then(r=>r&&200===r.status?{asin:e,data:r.data,marketplace:a,hazDiagRunId:t,configMarketplace:n}:null).catch(()=>{throw new Error("submitAsin error")})},getFormInputAsin=async({asin:e=null,hazDiagRunId:t=null,marketplace:a=null,configMarketplace:n})=>{if(axios.default.withCredentials=!0,!e||!t)return null;const r="workflowId=fba_dangerous_goods&requiredAttributes%5B%5D=seller_intent&"+Qs.stringify({currentStepName:"determine_seller_intent_na_or_eu_task_1ozyrjg","sxaugur.encrypt.newAttributes":JSON.stringify({seller_intent:"look_up_an_asin"}),diagRunId:t,client:"FullPageHelp",paramountEphUser:"undefined",paramountEphUuid:"undefined",isResumingWorkflow:"false"});return axios({method:"post",url:`${n.sellerCentralUrl}/help/workflow/execute-workflow?mons_sel_persist=false&${getHazmatParamsForMarketplace(a)}`,headers:{},data:r}).then(r=>r&&200===r.status?{asin:e,hazDiagRunId:t,marketplace:a,configMarketplace:n}:null).catch(()=>{throw new Error("getFormInputAsin error")})},submitAsinOld=({asin:e=null,hazDiagRunId:t=null,marketplace:a,configMarketplace:n})=>{if(axios.default.withCredentials=!0,!e||!t)return null;const r=`workflowId=fba_dangerous_goods&requiredAttributes%5B%5D=item_id&requiredAttributes%5B%5D=obtain_asin_blurb&requiredAttributes%5B%5D=continue_task_18ie4by&currentStepName=obtain_asin_task_18ie4by&sxaugur.encrypt.newAttributes=%7B%22continue_task_18ie4by%22%3A%22true%22%2C%22item_id%22%3A%22${e}%22%7D&diagRunId=${t}&client=FullPageHelp&paramountEphUser=undefined&paramountEphUuid=undefined&isResumingWorkflow=false`;return axios({method:"post",url:`${n.sellerCentralUrl}/help/workflow/execute-workflow?${getHazmatParamsForMarketplace(a)}`,data:r,headers:{pragma:"no-cache","accept-language":"en,ko;q=0.9,vi;q=0.8,cs;q=0.7","content-type":"application/x-www-form-urlencoded",accept:"application/json, text/plain, */*","cache-control":"no-cache",authority:"sellercentral.amazon.com","x-requested-with":"XMLHttpRequest"}}).then(t=>t&&200===t.status?{asin:e,data:t.data,marketplace:a}:null).catch(()=>{throw new Error("submitAsin error")})},getFormInputAsinOld=async({asin:e=null,hazDiagRunId:t=null,marketplace:a=null,configMarketplace:n})=>{if(axios.default.withCredentials=!0,!e||!t)return null;const r="workflowId=fba_dangerous_goods&requiredAttributes%5B%5D=is_asin_available&"+Qs.stringify({currentStepName:"determine_if_seller_has_an_asin_task_1ozyrjg","sxaugur.encrypt.newAttributes":JSON.stringify({is_asin_available:"Yes"}),diagRunId:t,client:"FullPageHelp",paramountEphUser:"undefined",paramountEphUuid:"undefined",isResumingWorkflow:!1});return axios({method:"post",url:`${n.sellerCentralUrl}/help/workflow/execute-workflow?${getHazmatParamsForMarketplace(a)}`,headers:{},data:r}).then(r=>r&&200===r.status?{asin:e,hazDiagRunId:t,marketplace:a,configMarketplace:n}:null).catch(()=>{throw new Error("getFormInputAsin error")})},findHazRunId=async(e,t,a)=>(axios.default.withCredentials=!0,axios({method:"POST",url:e.sellerCentralUrl+"/help/workflow/execute-workflow?mons_sel_persist=false",data:"workflowId=fba_dangerous_goods&requiredAttributes=&currentStepName=&sxaugur.encrypt.newAttributes=&diagRunId=&client=FullPageHelp&isResumingWorkflow=false&isSurveyWorkflow=false&diagnosticCallerName=&diagRunIdCaller=&pendingSurveyWorkflows="}).then(async n=>{if(n&&200===n.status){let r=(new DOMParser).parseFromString(n.data,"text/html").querySelector("#augur-paramount-ui")||null;return r=r&&r.getAttribute("data-workflow-attr")||null,r=r&&JSON.parse(r)||null,r=r&&r.diagRunId||null,{asin:t,hazDiagRunId:r,marketplace:a,configMarketplace:e}}return null}).catch(()=>{throw new Error("findHazRunId error")})),cancelAndRestart=async({hazDiagRunId:e,marketplace:t,configMarketplace:a})=>{axios.default.withCredentials=!0,await axios({method:"POST",url:`${a.sellerCentralUrl}/help/workflow/cancel-workflow?mons_sel_persist=false&${getHazmatParamsForMarketplace(t)}`,data:"workflowId=fba_dangerous_goods&diagRunId="+e}).catch(()=>!1)},apiCheckLoginSellerCentral=async({domain:e})=>{const t=window.listMarketplaces[e];return axios.get(t.sellerCentralUrl+"/gp/homepage.html").then(e=>!(!e||200!==e.status)&&checkLoggedIn((new DOMParser).parseFromString(e.data,"text/html"))).catch(e=>{throw new Error("apiCheckLoginSellerCentral error: "+e.message)})},checkLoggedIn=e=>{const t=!e.getElementById("sign-in-button"),a=!e.getElementById("signInSubmit"),n=!e.getElementById("auth-signin-button");return t&&a&&n};